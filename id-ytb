// File: youtube-channel-id-extractor.js
// Ch·ª©c nƒÉng: L·∫•y ID k√™nh YouTube t·ª´ URL k√™nh
// 
// ============================================
// SHARED DEPENDENCIES (t·ª´ file script-notice):
// - CONFIG.YOUTUBE_API_KEY: API key ƒë·ªÉ g·ªçi YouTube API
// - getChannelName(channelId): H√†m l·∫•y t√™n k√™nh t·ª´ ID
// ============================================
//
// L∆∞u √Ω: Trong Google Apps Script, t·∫•t c·∫£ c√°c file trong c√πng project
// share chung scope, n√™n c√°c bi·∫øn v√† h√†m t·ª´ script-notice c√≥ th·ªÉ 
// ƒë∆∞·ª£c s·ª≠ d·ª•ng tr·ª±c ti·∫øp m√† kh√¥ng c·∫ßn import.

// Array URLs k√™nh YouTube c·∫ßn l·∫•y ID
const CHANNEL_URLS = [
    "https://www.youtube.com/@ZoCoMarketing/",
    // Th√™m URLs ·ªü ƒë√¢y...
];

/**
 * H√†m ch√≠nh: L·∫•y Channel ID t·ª´ array URLs ƒë√£ ƒë·ªãnh nghƒ©a s·∫µn
 */
function getChannelIdFromUrl() {
    Logger.log("=== B·∫Øt ƒë·∫ßu l·∫•y Channel ID t·ª´ URLs ===");
    Logger.log(`T·ªïng s·ªë URLs: ${CHANNEL_URLS.length}\n`);

    const results = [];

    CHANNEL_URLS.forEach((url, index) => {
        Logger.log(`[${index + 1}/${CHANNEL_URLS.length}] X·ª≠ l√Ω: ${url}`);
        const result = processSingleUrl(url);
        results.push(result);

        if (result.success) {
            Logger.log(`‚úÖ ${result.channelName} ‚Üí ${result.channelId}`);
        } else {
            Logger.log(`‚ùå L·ªói: ${result.error}`);
        }

        // ƒê·ª£i 1 gi√¢y gi·ªØa c√°c request
        if (index < CHANNEL_URLS.length - 1) {
            Utilities.sleep(1000);
        }
        Logger.log("");
    });

    // T·ªïng k·∫øt
    const successCount = results.filter(r => r.success).length;
    Logger.log("===================");
    Logger.log(`üìä T·ªïng k·∫øt: ${successCount}/${CHANNEL_URLS.length} th√†nh c√¥ng`);

    // In ra danh s√°ch Channel IDs
    Logger.log("\nüìã Danh s√°ch Channel IDs:");
    results.forEach((result, index) => {
        if (result.success) {
            Logger.log(`  { id: "${result.channelId}", name: "${result.channelName}" },`);
        }
    });

    return results;
}

/**
 * X·ª≠ l√Ω m·ªôt URL duy nh·∫•t
 */
function processSingleUrl(channelUrl) {
    try {
        // Ki·ªÉm tra v√† l√†m s·∫°ch URL
        if (!channelUrl || typeof channelUrl !== 'string') {
            throw new Error('URL kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng ph·∫£i l√† string.');
        }

        const cleanUrl = channelUrl.trim();

        // Ki·ªÉm tra URL c√≥ h·ª£p l·ªá kh√¥ng
        if (!cleanUrl.includes('youtube.com')) {
            throw new Error('URL kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p URL YouTube.');
        }

        // Tr∆∞·ªùng h·ª£p 1: URL ƒë√£ ch·ª©a Channel ID (UC...)
        const channelIdMatch = cleanUrl.match(/\/channel\/(UC[a-zA-Z0-9_-]{22})/);
        if (channelIdMatch) {
            const channelId = channelIdMatch[1];
            Logger.log(`T√¨m th·∫•y Channel ID tr·ª±c ti·∫øp: ${channelId}`);
            return {
                success: true,
                channelId: channelId,
                channelName: getChannelName(channelId),
                method: 'direct'
            };
        }

        // Tr∆∞·ªùng h·ª£p 2: URL d·∫°ng /c/channelname
        const customUrlMatch = cleanUrl.match(/\/c\/([a-zA-Z0-9_-]+)/);
        if (customUrlMatch) {
            const customName = customUrlMatch[1];
            Logger.log(`T√¨m th·∫•y custom URL: ${customName}`);
            return searchChannelByCustomUrl(customName, 'c');
        }

        // Tr∆∞·ªùng h·ª£p 3: URL d·∫°ng /@channelname
        const handleMatch = cleanUrl.match(/\/@([a-zA-Z0-9_-]+)/);
        if (handleMatch) {
            const handle = handleMatch[1];
            Logger.log(`T√¨m th·∫•y handle: @${handle}`);
            return searchChannelByCustomUrl(handle, 'handle');
        }

        // Tr∆∞·ªùng h·ª£p 4: URL d·∫°ng /user/username
        const userMatch = cleanUrl.match(/\/user\/([a-zA-Z0-9_-]+)/);
        if (userMatch) {
            const username = userMatch[1];
            Logger.log(`T√¨m th·∫•y username: ${username}`);
            return searchChannelByCustomUrl(username, 'user');
        }

        throw new Error('Kh√¥ng th·ªÉ nh·∫≠n di·ªán ƒë·ªãnh d·∫°ng URL n√†y.');

    } catch (error) {
        Logger.log('L·ªói khi x·ª≠ l√Ω URL: ' + error.toString());
        return {
            success: false,
            error: error.toString(),
            url: channelUrl
        };
    }
}

/**
 * T√¨m ki·∫øm Channel ID th√¥ng qua YouTube API b·∫±ng custom URL/handle/username
 */
function searchChannelByCustomUrl(identifier, type) {
    try {
        // Th·ª≠ t√¨m ki·∫øm b·∫±ng forHandle (cho @channelname)
        if (type === 'handle') {
            const handleResult = searchByHandle(identifier);
            if (handleResult.success) {
                return handleResult;
            }
        }

        // Th·ª≠ t√¨m ki·∫øm b·∫±ng forUsername (cho user/username)
        if (type === 'user') {
            const userResult = searchByUsername(identifier);
            if (userResult.success) {
                return userResult;
            }
        }

        // Ph∆∞∆°ng ph√°p cu·ªëi: T√¨m ki·∫øm chung
        return searchChannelByQuery(identifier, type);

    } catch (error) {
        Logger.log(`L·ªói khi t√¨m ki·∫øm ${type}/${identifier}: ` + error.toString());
        return {
            success: false,
            error: error.toString()
        };
    }
}

/**
 * T√¨m ki·∫øm b·∫±ng handle (@channelname)
 */
function searchByHandle(handle) {
    try {
        const url = `https://www.googleapis.com/youtube/v3/channels?key=${CONFIG.YOUTUBE_API_KEY}&forHandle=${handle}&part=id,snippet`;
        const response = UrlFetchApp.fetch(url);
        const data = JSON.parse(response.getContentText());

        if (data.items && data.items.length > 0) {
            const channel = data.items[0];
            return {
                success: true,
                channelId: channel.id,
                channelName: channel.snippet.title,
                method: 'handle'
            };
        }

        return { success: false };
    } catch (error) {
        Logger.log('L·ªói searchByHandle: ' + error.toString());
        return { success: false };
    }
}

/**
 * T√¨m ki·∫øm b·∫±ng username
 */
function searchByUsername(username) {
    try {
        const url = `https://www.googleapis.com/youtube/v3/channels?key=${CONFIG.YOUTUBE_API_KEY}&forUsername=${username}&part=id,snippet`;
        const response = UrlFetchApp.fetch(url);
        const data = JSON.parse(response.getContentText());

        if (data.items && data.items.length > 0) {
            const channel = data.items[0];
            return {
                success: true,
                channelId: channel.id,
                channelName: channel.snippet.title,
                method: 'username'
            };
        }

        return { success: false };
    } catch (error) {
        Logger.log('L·ªói searchByUsername: ' + error.toString());
        return { success: false };
    }
}

/**
 * T√¨m ki·∫øm k√™nh b·∫±ng Search API (ph∆∞∆°ng ph√°p cu·ªëi)
 */
function searchChannelByQuery(identifier, type) {
    try {
        const url = `https://www.googleapis.com/youtube/v3/search?key=${CONFIG.YOUTUBE_API_KEY}&q=${encodeURIComponent(identifier)}&type=channel&part=id,snippet&maxResults=5`;
        const response = UrlFetchApp.fetch(url);
        const data = JSON.parse(response.getContentText());

        if (data.items && data.items.length > 0) {
            // L·∫•y k·∫øt qu·∫£ ƒë·∫ßu ti√™n (c√≥ th·ªÉ kh√¥ng ch√≠nh x√°c 100%)
            const channel = data.items[0];
            return {
                success: true,
                channelId: channel.id.channelId,
                channelName: channel.snippet.title,
                method: 'search',
                note: 'K·∫øt qu·∫£ t·ª´ t√¨m ki·∫øm - c√≥ th·ªÉ kh√¥ng ch√≠nh x√°c 100%'
            };
        }

        return {
            success: false,
            error: `Kh√¥ng t√¨m th·∫•y k√™nh v·ªõi ${type}: ${identifier}`
        };

    } catch (error) {
        Logger.log('L·ªói searchChannelByQuery: ' + error.toString());
        return {
            success: false,
            error: error.toString()
        };
    }
}

/**
 * H√†m test ƒë·ªÉ ki·ªÉm tra c√°c lo·∫°i URL (c√≥ th·ªÉ test c·∫£ array)
 */
function testChannelIdExtraction() {
    Logger.log("=== Test l·∫•y Channel ID t·ª´ URL ===");

    // Test single URL
    Logger.log("\n--- Test Single URL ---");
    const singleUrl = "https://www.youtube.com/channel/UCWquNQV8Y0_defMKnGKrFOQ";
    const singleResult = getChannelIdFromUrl(singleUrl);
    logResult(singleResult, singleUrl);

    // Test array URLs
    Logger.log("\n--- Test Array URLs ---");
    const testUrls = [
        "https://www.youtube.com/channel/UCWquNQV8Y0_defMKnGKrFOQ",
        "https://www.youtube.com/@MrBeast",
        "https://www.youtube.com/c/TechReview",
        "https://www.youtube.com/user/GoogleDevelopers"
    ];

    const results = getChannelIdFromUrl(testUrls);

    // Log k·∫øt qu·∫£ array
    if (Array.isArray(results)) {
        results.forEach((result, index) => {
            Logger.log(`\nK·∫øt qu·∫£ ${index + 1}:`);
            logResult(result, testUrls[index]);
        });
    }
}

/**
 * H√†m helper ƒë·ªÉ log k·∫øt qu·∫£
 */
function logResult(result, url) {
    Logger.log(`URL: ${url}`);
    if (result.success) {
        Logger.log(`‚úÖ Th√†nh c√¥ng!`);
        Logger.log(`   Channel ID: ${result.channelId}`);
        Logger.log(`   Channel Name: ${result.channelName}`);
        Logger.log(`   Method: ${result.method}`);
        if (result.note) {
            Logger.log(`   Note: ${result.note}`);
        }
    } else {
        Logger.log(`‚ùå Th·∫•t b·∫°i: ${result.error}`);
    }
}

/**
 * H√†m ƒë·ªÉ x·ª≠ l√Ω nhi·ªÅu URL c√πng l√∫c v·ªõi format ƒë·∫πp
 */
function processMultipleUrls(urlArray) {
    Logger.log("=== X·ª≠ l√Ω nhi·ªÅu URL ===");

    if (!Array.isArray(urlArray)) {
        Logger.log("Input ph·∫£i l√† array c·ªßa URLs");
        return;
    }

    const results = getChannelIdFromUrl(urlArray);

    if (Array.isArray(results)) {
        Logger.log(`\nƒê√£ x·ª≠ l√Ω ${results.length} URL(s):`);

        results.forEach((result, index) => {
            Logger.log(`\n${index + 1}. ${urlArray[index]}`);

            if (result.success) {
                Logger.log(`   ‚úÖ ${result.channelName} (${result.channelId})`);
            } else {
                Logger.log(`   ‚ùå ${result.error}`);
            }
        });

        // T·ªïng h·ª£p
        const successCount = results.filter(r => r.success).length;
        Logger.log(`\nüìä T·ªïng k·∫øt: ${successCount}/${results.length} th√†nh c√¥ng`);

        return results;
    }

    return results;
}

/**
 * V√≠ d·ª• s·ª≠ d·ª•ng v·ªõi array URLs
 */
function exampleUsage() {
    // V√≠ d·ª• 1: Single URL
    const singleUrl = "https://www.youtube.com/@MrBeast";
    const result1 = getChannelIdFromUrl(singleUrl);
    Logger.log("Single result:", result1);

    // V√≠ d·ª• 2: Array URLs
    const multipleUrls = [
        "https://www.youtube.com/channel/UCWquNQV8Y0_defMKnGKrFOQ",
        "https://www.youtube.com/@pewdiepie",
        "https://www.youtube.com/c/TechReview"
    ];

    const results = getChannelIdFromUrl(multipleUrls);
    Logger.log("Multiple results:", results);

    // V√≠ d·ª• 3: S·ª≠ d·ª•ng h√†m helper
    processMultipleUrls(multipleUrls);
}

/**
 * H√†m ti·ªán √≠ch ƒë·ªÉ l·∫•y th√¥ng tin k√™nh t·ª´ URL (k·∫øt h·ª£p c·∫£ hai ch·ª©c nƒÉng)
 */
function getChannelInfoFromUrl(channelUrl) {
    const result = getChannelIdFromUrl(channelUrl);

    if (result.success) {
        // L·∫•y th√™m th√¥ng tin chi ti·∫øt v·ªÅ k√™nh
        const channelInfo = getDetailedChannelInfo(result.channelId);

        return {
            ...result,
            ...channelInfo
        };
    }

    return result;
}

/**
 * L·∫•y th√¥ng tin chi ti·∫øt v·ªÅ k√™nh
 */
function getDetailedChannelInfo(channelId) {
    try {
        const url = `https://www.googleapis.com/youtube/v3/channels?key=${CONFIG.YOUTUBE_API_KEY}&id=${channelId}&part=snippet,statistics`;
        const response = UrlFetchApp.fetch(url);
        const data = JSON.parse(response.getContentText());

        if (data.items && data.items.length > 0) {
            const channel = data.items[0];
            return {
                description: channel.snippet.description,
                subscriberCount: channel.statistics.subscriberCount,
                videoCount: channel.statistics.videoCount,
                viewCount: channel.statistics.viewCount,
                publishedAt: channel.snippet.publishedAt,
                thumbnails: channel.snippet.thumbnails
            };
        }
    } catch (error) {
        Logger.log('L·ªói khi l·∫•y th√¥ng tin chi ti·∫øt: ' + error.toString());
    }

    return {};
}

/**
 * H√†m ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p URL v√† l·∫•y ID
 */
function extractChannelId() {
    // Trong Google Apps Script, c√≥ th·ªÉ d√πng Browser.inputBox ho·∫∑c t·∫°o HTML dialog
    const url = Browser.inputBox('Nh·∫≠p URL k√™nh YouTube:', Browser.Buttons.OK_CANCEL);

    if (url === 'cancel' || !url) {
        Logger.log('Ng∆∞·ªùi d√πng ƒë√£ h·ªßy.');
        return;
    }

    Logger.log(`URL nh·∫≠p: ${url}`);
    const result = getChannelInfoFromUrl(url);

    if (result.success) {
        Logger.log('=== TH√îNG TIN K√äNH ===');
        Logger.log(`Channel ID: ${result.channelId}`);
        Logger.log(`T√™n k√™nh: ${result.channelName}`);
        Logger.log(`Subscriber: ${result.subscriberCount || 'N/A'}`);
        Logger.log(`S·ªë video: ${result.videoCount || 'N/A'}`);
        Logger.log(`T·ªïng view: ${result.viewCount || 'N/A'}`);

        // Hi·ªÉn th·ªã k·∫øt qu·∫£ cho ng∆∞·ªùi d√πng
        Browser.msgBox(
            'Th√†nh c√¥ng!',
            `Channel ID: ${result.channelId}\nT√™n k√™nh: ${result.channelName}`,
            Browser.Buttons.OK
        );
    } else {
        Logger.log(`L·ªói: ${result.error}`);
        Browser.msgBox('L·ªói', result.error, Browser.Buttons.OK);
    }
}

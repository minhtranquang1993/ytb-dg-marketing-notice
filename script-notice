// C·∫•u h√¨nh
const CONFIG = {
    TELEGRAM_BOT_TOKEN: '7784988616:AAEbCk6u5XF06sV5DbZnNH-nBCWFGos8Vk4',
    TELEGRAM_CHAT_ID: '1661694132',
    YOUTUBE_API_KEY: 'AIzaSyADR4G_MyHf8-M1yoZKo6_er5ebrT1_Lhg',
    GEMINI_API_KEY: 'AIzaSyCf-qhuwshjwnfyie_VxeNiq-YtWtPAB6U', // Key t·ª´ GitHub youtube-summarizer
    WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbyPa8QfMdp3K0alWSg5ntlaEfp7a31koxo7tVjrMaubGjN9v3SayBJlt2hivHNElmxN/exec' // URL Web App ƒë√£ Deploy
};

// C·∫•u h√¨nh icon cho t·ª´ng lo·∫°i k√™nh
const CHANNEL_ICONS = {
    // Nh√≥m 1: Qu·∫£ng c√°o
    "Facebook Ads": "üì¢",
    "Tiktok Ads": "üì¢",
    "PPC Ads": "üì¢",
    "Display Ads": "üì¢",
    "Google Ads": "üì¢",

    // Nh√≥m 2: Marketing/SEO
    "Digital Marketing": "üìà",
    "SEO": "üìà",

    // Nh√≥m 3: Ph√¢n t√≠ch/D·ªØ li·ªáu
    "Tracking": "üìä",
    "Data Analysis": "üìä",

    // Nh√≥m 4: Kh√°c
    "AI": "ü§ñ"
};

// H√†m l·∫•y icon d·ª±a tr√™n lo·∫°i k√™nh
function getChannelIcon(channelType) {
    return CHANNEL_ICONS[channelType] || "üì∫"; // Icon m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng t√¨m th·∫•y
}

// H√†m l·∫•y lo·∫°i k√™nh t·ª´ ID
function getChannelType(channelId) {
    const channel = CHANNELS.find(ch => ch.id === channelId);
    return channel ? channel.type : "Unknown";
}

// Danh s√°ch k√™nh YouTube c·∫ßn theo d√µi (ID, lo·∫°i k√™nh v√† t·ª´ kh√≥a l·ªçc ti√™u ƒë·ªÅ)
// title: ch·ª©a c√°c t·ª´ kh√≥a c√°ch nhau b·∫±ng d·∫•u ph·∫©y, ƒë·ªÉ r·ªóng "" n·∫øu mu·ªën l·∫•y t·∫•t c·∫£ video
const CHANNELS = [
    { id: "UCWquNQV8Y0_defMKnGKrFOQ", type: "SEO", title: "" },
    { id: "UC1I8fcAdjxy-YgChuzUIUPw", type: "SEO", title: "" },
    { id: "UCgl9rHdm9KojNRWs56QI_hg", type: "Google Ads", title: "" },
    { id: "UCjP4kqaIiSnxiLApPFrDOWA", type: "Display Ads", title: "" },
    { id: "UCTWH-WVfrorlwnF2fOjUqcw", type: "Tiktok Ads", title: "tiktok" },
    { id: "UCJ5UyIAa5nEGksjcdp43Ixw", type: "Tracking", title: "" },
    { id: "UCcBKibvrvNU6Zaf6UQoVUnA", type: "Data Analysis", title: "" },
    { id: "UCsifPO4MT6BdV19vYx3KJ0Q", type: "Google Ads", title: "" },
    { id: "UC0m81bQuthaQZmFbXEY9QSw", type: "AI", title: "" },
    { id: "UCctL30i8tVgSS9A37Q532eg", type: "AI", title: "" },
    { id: "UC5Dv8i_vH5M9rB3HOZDCkng", type: "Facebook Ads", title: "" },
    { id: "UCWqjZ2W4pOOErFealWwBSXA", type: "Facebook Ads", title: "" },
    { id: "UCNJ2hbCj5y7dYpMORqCXvmQ", type: "PPC Ads", title: "" },
    { id: "UCl-Zrl0QhF66lu1aGXaTbfw", type: "Digital Marketing", title: "" },
    { id: "UCPEZnYBqewx-h43B5tLymYw", type: "Digital Marketing", title: "" },
    { id: "UCVeuau7DLrg7zlAjxxDbdww", type: "Digital Marketing", title: "" },
    { id: "UClgihdkPzNDtuoQy4xDw5mA", type: "Tracking", title: "" },
];

// H√†m ki·ªÉm tra t·ª´ kh√≥a trong ti√™u ƒë·ªÅ video (kh√¥ng ph√¢n bi·ªát ch·ªØ hoa/th∆∞·ªùng)
function checkTitleKeywords(videoTitle, keywordsString) {
    // N·∫øu kh√¥ng c√≥ t·ª´ kh√≥a n√†o ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh, tr·∫£ v·ªÅ true (l·∫•y t·∫•t c·∫£)
    if (!keywordsString || keywordsString.trim() === "") {
        return { matched: true, matchedKeywords: [] };
    }

    // T√°ch chu·ªói t·ª´ kh√≥a th√†nh m·∫£ng v√† lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a
    const keywords = keywordsString.split(',')
        .map(keyword => keyword.trim().toLowerCase())
        .filter(keyword => keyword !== "");

    if (keywords.length === 0) {
        return { matched: true, matchedKeywords: [] };
    }

    // Chuy·ªÉn ti√™u ƒë·ªÅ video sang ch·ªØ th∆∞·ªùng ƒë·ªÉ so s√°nh
    const lowerVideoTitle = videoTitle.toLowerCase();

    // Ki·ªÉm tra t·ª´ng t·ª´ kh√≥a
    const matchedKeywords = [];
    for (const keyword of keywords) {
        if (lowerVideoTitle.includes(keyword)) {
            matchedKeywords.push(keyword);
        }
    }

    return {
        matched: matchedKeywords.length > 0,
        matchedKeywords: matchedKeywords
    };
}

// H√†m c·∫≠p nh·∫≠t th·ªëng k√™ t·ª´ kh√≥a kh·ªõp
function updateKeywordStats(channelId, matchedKeywords, videoTitle) {
    try {
        const props = PropertiesService.getScriptProperties();
        let keywordStats = JSON.parse(props.getProperty('KEYWORD_STATS') || '{"keywords": {}, "channels": {}}');

        const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD

        // C·∫≠p nh·∫≠t th·ªëng k√™ cho t·ª´ng t·ª´ kh√≥a kh·ªõp
        for (const keyword of matchedKeywords) {
            if (!keywordStats.keywords[keyword]) {
                keywordStats.keywords[keyword] = {
                    count: 0,
                    lastMatched: today,
                    channels: [],
                    lastVideoTitle: ""
                };
            }

            keywordStats.keywords[keyword].count++;
            keywordStats.keywords[keyword].lastMatched = today;
            keywordStats.keywords[keyword].lastVideoTitle = videoTitle;

            if (!keywordStats.keywords[keyword].channels.includes(channelId)) {
                keywordStats.keywords[keyword].channels.push(channelId);
            }
        }

        // C·∫≠p nh·∫≠t th·ªëng k√™ cho k√™nh
        if (!keywordStats.channels[channelId]) {
            keywordStats.channels[channelId] = {
                totalMatches: 0,
                keywords: []
            };
        }

        keywordStats.channels[channelId].totalMatches += matchedKeywords.length;

        // Th√™m t·ª´ kh√≥a m·ªõi v√†o danh s√°ch k√™nh (tr√πng l·∫∑p s·∫Ω ƒë∆∞·ª£c lo·∫°i b·ªè sau)
        for (const keyword of matchedKeywords) {
            if (!keywordStats.channels[channelId].keywords.includes(keyword)) {
                keywordStats.channels[channelId].keywords.push(keyword);
            }
        }

        // L∆∞u l·∫°i th·ªëng k√™
        props.setProperty('KEYWORD_STATS', JSON.stringify(keywordStats));

    } catch (error) {
        Logger.log('L·ªói khi c·∫≠p nh·∫≠t th·ªëng k√™ t·ª´ kh√≥a: ' + error.toString());
    }
}

// H√†m l·∫•y th·ªëng k√™ t·ª´ kh√≥a
function getKeywordStats() {
    try {
        const props = PropertiesService.getScriptProperties();
        const keywordStats = JSON.parse(props.getProperty('KEYWORD_STATS') || '{"keywords": {}, "channels": {}}');

        let message = "üìä <b>Th·ªëng k√™ t·ª´ kh√≥a kh·ªõp</b>\n\n";

        // Th·ªëng k√™ theo t·ª´ kh√≥a
        message += "üîç <b>Th·ªëng k√™ theo t·ª´ kh√≥a:</b>\n";
        const sortedKeywords = Object.entries(keywordStats.keywords)
            .sort((a, b) => b[1].count - a[1].count);

        for (const [keyword, stats] of sortedKeywords) {
            message += `‚Ä¢ <b>${keyword}</b>: ${stats.count} l·∫ßn kh·ªõp`;
            message += ` (L·∫ßn cu·ªëi: ${stats.lastMatched})\n`;
            message += `  ‚îî K√™nh: ${stats.channels.length} k√™nh\n`;
            if (stats.lastVideoTitle) {
                message += `  ‚îî Video g·∫ßn nh·∫•t: ${stats.lastVideoTitle.substring(0, 50)}${stats.lastVideoTitle.length > 50 ? "..." : ""}\n`;
            }
        }

        // Th·ªëng k√™ theo k√™nh
        message += "\nüì∫ <b>Th·ªëng k√™ theo k√™nh:</b>\n";
        const sortedChannels = Object.entries(keywordStats.channels)
            .sort((a, b) => b[1].totalMatches - a[1].totalMatches);

        for (const [channelId, stats] of sortedChannels) {
            const channelName = getChannelName(channelId);
            const channelType = getChannelType(channelId);
            message += `‚Ä¢ ${getChannelIcon(channelType)} <b>${channelName}</b>: ${stats.totalMatches} l·∫ßn kh·ªõp\n`;
            message += `  ‚îî T·ª´ kh√≥a: ${stats.keywords.join(", ")}\n`;
        }

        sendTelegramMessage(message);

        return keywordStats;

    } catch (error) {
        Logger.log('L·ªói khi l·∫•y th·ªëng k√™ t·ª´ kh√≥a: ' + error.toString());
        return null;
    }
}

// H√†m ƒë·∫∑t l·∫°i th·ªëng k√™ t·ª´ kh√≥a
function resetKeywordStats() {
    try {
        const props = PropertiesService.getScriptProperties();
        props.setProperty('KEYWORD_STATS', '{"keywords": {}, "channels": {}}');
        Logger.log('ƒê√£ ƒë·∫∑t l·∫°i th·ªëng k√™ t·ª´ kh√≥a');
        const msg = "üìä Th·ªëng k√™ t·ª´ kh√≥a ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t l·∫°i!";
        sendTelegramMessage(msg);
        if (CONFIG.ENABLE_ZALO) sendZaloMessage(msg);
    } catch (error) {
        Logger.log('L·ªói khi ƒë·∫∑t l·∫°i th·ªëng k√™ t·ª´ kh√≥a: ' + error.toString());
    }
}

// H√†m ch√≠nh ƒë·ªÉ ki·ªÉm tra video m·ªõi
function checkNewVideos() {
    try {
        const props = PropertiesService.getScriptProperties();
        const lastVideoIds = JSON.parse(props.getProperty('LAST_VIDEO_IDS') || '{}');
        const channelNames = JSON.parse(props.getProperty('CHANNEL_NAMES') || '{}');

        let updatedLastVideoIds = { ...lastVideoIds };
        let hasNewVideo = false;

        // Ki·ªÉm tra t·ª´ng k√™nh
        for (const channel of CHANNELS) {
            // L·∫•y video m·ªõi nh·∫•t t·ª´ k√™nh
            const latestVideo = getLatestVideo(channel.id);

            if (latestVideo) {
                const channelKey = channel.id;
                const storedVideoId = lastVideoIds[channelKey];

                // N·∫øu c√≥ video m·ªõi ho·∫∑c ch∆∞a t·ª´ng ƒë∆∞·ª£c l∆∞u tr·ªØ
                if (!storedVideoId || latestVideo.id !== storedVideoId) {
                    // L·∫•y t√™n k√™nh n·∫øu ch∆∞a c√≥
                    if (!channelNames[channelKey]) {
                        channelNames[channelKey] = getChannelName(channel.id);
                        props.setProperty('CHANNEL_NAMES', JSON.stringify(channelNames));
                    }

                    // Ki·ªÉm tra t·ª´ kh√≥a trong ti√™u ƒë·ªÅ
                    const keywordResult = checkTitleKeywords(latestVideo.title, channel.title || "");

                    // Ch·ªâ g·ª≠i th√¥ng b√°o n·∫øu t·ª´ kh√≥a kh·ªõp ho·∫∑c kh√¥ng c√≥ t·ª´ kh√≥a n√†o ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh
                    if (keywordResult.matched) {
                        // G·ª≠i th√¥ng b√°o
                        const name = channelNames[channelKey] || channel.id;
                        sendTelegramNotification(
                            name,
                            channel.type,
                            latestVideo,
                            keywordResult.matchedKeywords
                        );



                        // C·∫≠p nh·∫≠t th·ªëng k√™ t·ª´ kh√≥a n·∫øu c√≥ t·ª´ kh√≥a kh·ªõp
                        if (keywordResult.matchedKeywords.length > 0) {
                            updateKeywordStats(channel.id, keywordResult.matchedKeywords, latestVideo.title);
                        }

                        // C·∫≠p nh·∫≠t ID video m·ªõi nh·∫•t
                        updatedLastVideoIds[channelKey] = latestVideo.id;
                        hasNewVideo = true;

                        // ƒê·ª£i 1 gi√¢y tr∆∞·ªõc khi ki·ªÉm tra k√™nh ti·∫øp theo
                        Utilities.sleep(1000);
                    } else {
                        // N·∫øu kh√¥ng kh·ªõp t·ª´ kh√≥a, v·∫´n c·∫≠p nh·∫≠t ID video ƒë·ªÉ kh√¥ng ki·ªÉm tra l·∫°i
                        updatedLastVideoIds[channelKey] = latestVideo.id;
                        hasNewVideo = true;
                        Logger.log(`Video "${latestVideo.title}" t·ª´ k√™nh ${channelNames[channelKey] || channel.id} kh√¥ng kh·ªõp t·ª´ kh√≥a, b·ªè qua.`);
                    }
                }
            }
        }

        // L∆∞u tr·∫°ng th√°i m·ªõi
        if (hasNewVideo) {
            props.setProperty('LAST_VIDEO_IDS', JSON.stringify(updatedLastVideoIds));
        }
    } catch (error) {
        Logger.log('L·ªói: ' + error.toString());
    }
}

// H√†m g·ª≠i b√°o c√°o h√†ng ng√†y l√∫c 7h s√°ng
function sendDailyReport() {
    try {
        const props = PropertiesService.getScriptProperties();
        const channelNames = JSON.parse(props.getProperty('CHANNEL_NAMES') || '{}');

        // T√≠nh ng√†y h√¥m qua
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const startOfDay = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());
        const endOfDay = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate(), 23, 59, 59);

        let message = `<b>B√°o c√°o tin t·ª©c t·ª´ Youtube ng√†y ${formatDate(yesterday)}</b>\n\n`;
        let videoCount = 0;
        let keywordStats = {};

        // Ki·ªÉm tra t·ª´ng k√™nh
        for (const channel of CHANNELS) {
            // L·∫•y t√™n k√™nh n·∫øu ch∆∞a c√≥
            if (!channelNames[channel.id]) {
                channelNames[channel.id] = getChannelName(channel.id);
            }

            // L·∫•y video t·ª´ ng√†y h√¥m qua v·ªõi b·ªô l·ªçc t·ª´ kh√≥a
            const videos = getVideosFromChannel(channel.id, startOfDay, endOfDay, channel.title || "");

            if (videos.length > 0) {
                message += `${getChannelIcon(channel.type)} <b>${channelNames[channel.id] || channel.id}</b> (${channel.type}):\n`;

                // Gi·ªõi h·∫°n 2-3 video m·ªõi nh·∫•t
                const maxVideos = Math.min(videos.length, 3);
                for (let i = 0; i < maxVideos; i++) {
                    const video = videos[i];
                    message += `   ${i + 1}. <a href="${video.url}">${video.title}</a>\n`;

                    // Hi·ªÉn th·ªã t·ª´ kh√≥a kh·ªõp n·∫øu c√≥
                    if (video.matchedKeywords && video.matchedKeywords.length > 0) {
                        message += `      üîë T·ª´ kh√≥a: ${video.matchedKeywords.join(", ")}\n`;

                        // C·∫≠p nh·∫≠t th·ªëng k√™ t·ª´ kh√≥a cho b√°o c√°o
                        for (const keyword of video.matchedKeywords) {
                            if (!keywordStats[keyword]) {
                                keywordStats[keyword] = 0;
                            }
                            keywordStats[keyword]++;
                        }
                    }

                    videoCount++;
                }
                message += '\n';
            }

            // ƒê·ª£i 1 gi√¢y tr∆∞·ªõc khi ki·ªÉm tra k√™nh ti·∫øp theo
            Utilities.sleep(1000);
        }

        // Th√™m th·ªëng k√™ t·ª´ kh√≥a v√†o b√°o c√°o
        if (Object.keys(keywordStats).length > 0) {
            message += `üîë <b>Th·ªëng k√™ t·ª´ kh√≥a kh·ªõp:</b>\n`;
            const sortedKeywords = Object.entries(keywordStats)
                .sort((a, b) => b[1] - a[1]);

            for (const [keyword, count] of sortedKeywords) {
                message += `‚Ä¢ ${keyword}: ${count} video\n`;
            }
            message += '\n';
        }

        // L∆∞u t√™n k√™nh
        props.setProperty('CHANNEL_NAMES', JSON.stringify(channelNames));

        if (videoCount > 0) {
            message += `üìä T·ªïng c·ªông: ${videoCount} video m·ªõi`;
        } else {
            message += `üì≠ Kh√¥ng c√≥ video m·ªõi n√†o t·ª´ c√°c k√™nh theo d√µi trong ng√†y h√¥m qua.`;
            Logger.log('Kh√¥ng c√≥ video n√†o kh·ªõp t·ª´ kh√≥a ƒë∆∞·ª£c ƒëƒÉng trong ng√†y h√¥m qua');
        }
        
        // Lu√¥n g·ª≠i th√¥ng b√°o ƒë·ªÉ bi·∫øt h·ªá th·ªëng ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng
        sendTelegramMessage(message);
    } catch (error) {
        Logger.log('L·ªói khi g·ª≠i b√°o c√°o h√†ng ng√†y: ' + error.toString());
    }
}

// L·∫•y video t·ª´ k√™nh trong kho·∫£ng th·ªùi gian (c√≥ √°p d·ª•ng b·ªô l·ªçc t·ª´ kh√≥a)
function getVideosFromChannel(channelId, startDate, endDate, keywordsString = "") {
    try {
        const url = `https://www.googleapis.com/youtube/v3/search?key=${CONFIG.YOUTUBE_API_KEY}&channelId=${channelId}&part=snippet,id&order=date&maxResults=10&publishedAfter=${startDate.toISOString()}&publishedBefore=${endDate.toISOString()}`;
        const response = UrlFetchApp.fetch(url);
        const data = JSON.parse(response.getContentText());

        const videos = [];
        if (data.items && data.items.length > 0) {
            for (const item of data.items) {
                if (item.id.kind === 'youtube#video') {
                    const video = {
                        id: item.id.videoId,
                        title: item.snippet.title,
                        url: `https://www.youtube.com/watch?v=${item.id.videoId}`,
                        publishedAt: item.snippet.publishedAt
                    };

                    // √Åp d·ª•ng b·ªô l·ªçc t·ª´ kh√≥a n·∫øu c√≥
                    if (keywordsString && keywordsString.trim() !== "") {
                        const keywordResult = checkTitleKeywords(video.title, keywordsString);
                        if (keywordResult.matched) {
                            video.matchedKeywords = keywordResult.matchedKeywords;
                            videos.push(video);
                        }
                    } else {
                        // N·∫øu kh√¥ng c√≥ t·ª´ kh√≥a, l·∫•y t·∫•t c·∫£ video
                        video.matchedKeywords = [];
                        videos.push(video);
                    }
                }
            }
        }

        return videos;
    } catch (error) {
        Logger.log('L·ªói khi l·∫•y video t·ª´ k√™nh ' + channelId + ': ' + error.toString());
        return [];
    }
}

// L·∫•y video m·ªõi nh·∫•t t·ª´ k√™nh YouTube
function getLatestVideo(channelId) {
    try {
        const url = `https://www.googleapis.com/youtube/v3/search?key=${CONFIG.YOUTUBE_API_KEY}&channelId=${channelId}&part=snippet,id&order=date&maxResults=1`;
        const response = UrlFetchApp.fetch(url);
        const data = JSON.parse(response.getContentText());

        if (data.items && data.items.length > 0) {
            const video = data.items[0];
            return {
                id: video.id.videoId,
                title: video.snippet.title,
                url: `https://www.youtube.com/watch?v=${video.id.videoId}`,
                publishedAt: video.snippet.publishedAt
            };
        }
    } catch (error) {
        Logger.log('L·ªói khi l·∫•y video t·ª´ k√™nh ' + channelId + ': ' + error.toString());
    }
    return null;
}

// L·∫•y t√™n k√™nh t·ª´ ID
function getChannelName(channelId) {
    try {
        const url = `https://www.googleapis.com/youtube/v3/channels?key=${CONFIG.YOUTUBE_API_KEY}&id=${channelId}&part=snippet`;
        const response = UrlFetchApp.fetch(url);
        const data = JSON.parse(response.getContentText());

        if (data.items && data.items.length > 0) {
            return data.items[0].snippet.title;
        }
    } catch (error) {
        Logger.log('L·ªói khi l·∫•y t√™n k√™nh ' + channelId + ': ' + error.toString());
    }
    return "Unknown Channel";
}

// G·ª≠i th√¥ng b√°o qua Telegram
function sendTelegramNotification(channelName, channelType, video, matchedKeywords = []) {
    try {
        const publishedDate = new Date(video.publishedAt);
        const formattedDate = formatDate(publishedDate);

        let message = `
üé• <b>Video m·ªõi t·ª´ ${channelName}</b>
üìÅ <b>Lo·∫°i:</b> ${channelType}
${getChannelIcon(channelType)} <b>Ti√™u ƒë·ªÅ:</b> ${video.title}
‚è∞ <b>ƒêƒÉng l√∫c:</b> ${formattedDate}
    `;

        // Th√™m th√¥ng tin t·ª´ kh√≥a kh·ªõp n·∫øu c√≥
        if (matchedKeywords && matchedKeywords.length > 0) {
            message += `üîë <b>T·ª´ kh√≥a kh·ªõp:</b> ${matchedKeywords.join(", ")}\n`;
        }

        message += `üîó <b>Xem ngay:</b> ${video.url}`;

        // G·ª≠i th√¥ng b√°o
        sendTelegramMessage(message);
        Logger.log('ƒê√£ g·ª≠i th√¥ng b√°o Telegram cho video m·ªõi t·ª´ k√™nh: ' + channelName);
    } catch (error) {
        Logger.log('L·ªói khi g·ª≠i Telegram: ' + error.toString());
    }
}


// G·ª≠i tin nh·∫Øn Telegram
function sendTelegramMessage(message) {
    const url = `https://api.telegram.org/bot${CONFIG.TELEGRAM_BOT_TOKEN}/sendMessage`;
    const payload = {
        method: 'post',
        payload: {
            chat_id: CONFIG.TELEGRAM_CHAT_ID,
            text: message,
            parse_mode: 'HTML',
            disable_web_page_preview: false
        }
    };

    UrlFetchApp.fetch(url, payload);
}

// ƒê·ªãnh d·∫°ng ng√†y th√°ng
function formatDate(date) {
    return date.toLocaleDateString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// H√†m kh·ªüi t·∫°o - ch·∫°y m·ªôt l·∫ßn ƒë·∫ßu ti√™n
function initialize() {
    const props = PropertiesService.getScriptProperties();
    const initialData = {};
    const channelNames = {};

    // Kh·ªüi t·∫°o th·ªëng k√™ t·ª´ kh√≥a
    props.setProperty('KEYWORD_STATS', '{"keywords": {}, "channels": {}}');
    Logger.log('ƒê√£ kh·ªüi t·∫°o th·ªëng k√™ t·ª´ kh√≥a');

    // Kh·ªüi t·∫°o d·ªØ li·ªáu cho t·∫•t c·∫£ k√™nh
    for (const channel of CHANNELS) {
        const latestVideo = getLatestVideo(channel.id);
        if (latestVideo) {
            initialData[channel.id] = latestVideo.id;
            channelNames[channel.id] = getChannelName(channel.id);
            Logger.log('ƒê√£ kh·ªüi t·∫°o cho k√™nh: ' + channelNames[channel.id] + ', Video ID: ' + latestVideo.id);
            Utilities.sleep(1000); // ƒê·ª£i 1 gi√¢y gi·ªØa c√°c y√™u c·∫ßu
        }
    }

    props.setProperty('LAST_VIDEO_IDS', JSON.stringify(initialData));
    props.setProperty('CHANNEL_NAMES', JSON.stringify(channelNames));
    Logger.log('Kh·ªüi t·∫°o ho√†n t·∫•t!');
}

// H√†m test - ki·ªÉm tra g·ª≠i th√¥ng b√°o
function testNotification() {
    Logger.log("B·∫Øt ƒë·∫ßu ki·ªÉm tra th√¥ng b√°o...");
    // ... (gi·ªØ nguy√™n code test c≈©)

    // Ki·ªÉm tra l·∫•y t√™n k√™nh
    for (const channel of CHANNELS) {
        const channelName = getChannelName(channel.id);
        Logger.log(`K√™nh: ${channel.id} -> T√™n: ${channelName}, T·ª´ kh√≥a: ${channel.title || "Kh√¥ng l·ªçc"}`);
        Utilities.sleep(1000);
    }

    // Ki·ªÉm tra l·∫•y video m·ªõi nh·∫•t
    const testChannel = CHANNELS[0];
    const latestVideo = getLatestVideo(testChannel.id);
    if (latestVideo) {
        Logger.log(`Video m·ªõi nh·∫•t: ${latestVideo.title}`);

        // Ki·ªÉm tra t·ª´ kh√≥a
        const keywordResult = checkTitleKeywords(latestVideo.title, testChannel.title || "");
        Logger.log(`Kh·ªõp t·ª´ kh√≥a: ${keywordResult.matched ? "C√≥" : "Kh√¥ng"}`);
        if (keywordResult.matchedKeywords.length > 0) {
            Logger.log(`T·ª´ kh√≥a kh·ªõp: ${keywordResult.matchedKeywords.join(", ")}`);
        }

        // Ch·ªâ g·ª≠i th√¥ng b√°o n·∫øu kh·ªõp t·ª´ kh√≥a ho·∫∑c kh√¥ng c√≥ t·ª´ kh√≥a
        if (keywordResult.matched) {
            // Ki·ªÉm tra g·ª≠i th√¥ng b√°o
            const channelName = getChannelName(testChannel.id);
            sendTelegramNotification(channelName, testChannel.type, latestVideo, keywordResult.matchedKeywords);

            Logger.log("ƒê√£ g·ª≠i th√¥ng b√°o test!");
        } else {
            Logger.log("Video kh√¥ng kh·ªõp t·ª´ kh√≥a, kh√¥ng g·ª≠i th√¥ng b√°o test");
        }
    } else {
        Logger.log("Kh√¥ng t√¨m th·∫•y video n√†o ƒë·ªÉ test");
    }
}

// H√†m test b√°o c√°o h√†ng ng√†y
function testDailyReport() {
    Logger.log("B·∫Øt ƒë·∫ßu ki·ªÉm tra b√°o c√°o h√†ng ng√†y...");

    // Thi·∫øt l·∫≠p ng√†y h√¥m qua
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const startOfDay = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());
    const endOfDay = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate(), 23, 59, 59);

    Logger.log(`Ki·ªÉm tra video t·ª´ ${startOfDay} ƒë·∫øn ${endOfDay}`);

    // Ki·ªÉm tra l·∫•y video t·ª´ k√™nh
    for (const channel of CHANNELS) {
        const videos = getVideosFromChannel(channel.id, startOfDay, endOfDay);
        Logger.log(`K√™nh ${channel.id} c√≥ ${videos.length} video`);

        if (videos.length > 0) {
            for (const video of videos) {
                Logger.log(`- ${video.title}`);
            }
        }

        Utilities.sleep(1000);
    }

    // G·ª≠i b√°o c√°o test
    sendDailyReport();
    Logger.log("ƒê√£ g·ª≠i b√°o c√°o test!");
}

// H√†m test ch·ª©c nƒÉng l·ªçc t·ª´ kh√≥a
function testKeywordFilter() {
    Logger.log("B·∫Øt ƒë·∫ßu ki·ªÉm tra ch·ª©c nƒÉng l·ªçc t·ª´ kh√≥a...");

    // Test cases
    const testCases = [
        { title: "SEO Tutorial for Beginners", keywords: "tutorial,seo", expected: true },
        { title: "Advanced Google Ads Techniques", keywords: "tutorial,seo", expected: false },
        { title: "Complete Guide to Facebook Marketing", keywords: "guide,marketing", expected: true },
        { title: "Data Analysis with Python", keywords: "marketing,tips", expected: false },
        { title: "AI and Machine Learning", keywords: "", expected: true }, // Kh√¥ng l·ªçc
        { title: "Tips for Better Conversion Tracking", keywords: "tips,tracking", expected: true },
        { title: "PAY PER CLICK STRATEGY", keywords: "ppc,pay per click", expected: true }, // Test kh√¥ng ph√¢n bi·ªát hoa/th∆∞·ªùng
    ];

    let passedTests = 0;
    let totalTests = testCases.length;

    for (let i = 0; i < testCases.length; i++) {
        const testCase = testCases[i];
        const result = checkTitleKeywords(testCase.title, testCase.keywords);

        if (result.matched === testCase.expected) {
            Logger.log(`‚úÖ Test ${i + 1} PASSED: "${testCase.title}" v·ªõi t·ª´ kh√≥a "${testCase.keywords}"`);
            passedTests++;
        } else {
            Logger.log(`‚ùå Test ${i + 1} FAILED: "${testCase.title}" v·ªõi t·ª´ kh√≥a "${testCase.keywords}" - Expected: ${testCase.expected}, Got: ${result.matched}`);
        }

        if (result.matched) {
            Logger.log(`   T·ª´ kh√≥a kh·ªõp: ${result.matchedKeywords.join(", ")}`);
        }
    }

    Logger.log(`\nK·∫øt qu·∫£: ${passedTests}/${totalTests} tests passed`);

    // Test v·ªõi k√™nh th·ª±c t·∫ø
    Logger.log("\nKi·ªÉm tra v·ªõi k√™nh th·ª±c t·∫ø...");
    const testChannel = CHANNELS[0];
    const latestVideo = getLatestVideo(testChannel.id);

    if (latestVideo) {
        Logger.log(`K√™nh: ${testChannel.type} (${testChannel.id})`);
        Logger.log(`T·ª´ kh√≥a: ${testChannel.title}`);
        Logger.log(`Video m·ªõi nh·∫•t: "${latestVideo.title}"`);

        const keywordResult = checkTitleKeywords(latestVideo.title, testChannel.title || "");
        Logger.log(`Kh·ªõp t·ª´ kh√≥a: ${keywordResult.matched ? "C√≥" : "Kh√¥ng"}`);
        if (keywordResult.matchedKeywords.length > 0) {
            Logger.log(`T·ª´ kh√≥a kh·ªõp: ${keywordResult.matchedKeywords.join(", ")}`);
        }
    } else {
        Logger.log("Kh√¥ng t√¨m th·∫•y video n√†o ƒë·ªÉ test");
    }
}

// H√†m test th·ªëng k√™ t·ª´ kh√≥a
function testKeywordStats() {
    Logger.log("B·∫Øt ƒë·∫ßu ki·ªÉm tra th·ªëng k√™ t·ª´ kh√≥a...");

    // Test c·∫≠p nh·∫≠t th·ªëng k√™
    const testChannelId = "test_channel_id";
    const testKeywords = ["tutorial", "seo"];
    const testVideoTitle = "SEO Tutorial for Beginners";

    updateKeywordStats(testChannelId, testKeywords, testVideoTitle);
    Logger.log("ƒê√£ c·∫≠p nh·∫≠t th·ªëng k√™ test");

    // L·∫•y v√† hi·ªÉn th·ªã th·ªëng k√™
    getKeywordStats();

    Logger.log("Ho√†n th√†nh ki·ªÉm tra th·ªëng k√™ t·ª´ kh√≥a!");
}

// H√†m test icon k√™nh
function testChannelIcons() {
    Logger.log("B·∫Øt ƒë·∫ßu ki·ªÉm tra icon k√™nh...");

    // Test t·∫•t c·∫£ c√°c lo·∫°i k√™nh
    const channelTypes = [
        "Facebook Ads", "Tiktok Ads", "PPC Ads", "Display Ads", "Google Ads",
        "Digital Marketing", "SEO",
        "Tracking", "Data Analysis",
        "AI", "Unknown Type"
    ];

    Logger.log("=== KI·ªÇM TRA ICON CHO T·ª™NG LO·∫†I K√äNH ===");
    for (const type of channelTypes) {
        const icon = getChannelIcon(type);
        Logger.log(`${type}: ${icon}`);
    }

    // Test v·ªõi c√°c k√™nh th·ª±c t·∫ø trong m·∫£ng CHANNELS
    Logger.log("\n=== KI·ªÇM TRA ICON CHO C√ÅC K√äNH TH·ª∞C T·∫æ ===");
    for (const channel of CHANNELS) {
        const icon = getChannelIcon(channel.type);
        Logger.log(`${channel.type} (${channel.id}): ${icon}`);
    }

    Logger.log("Ho√†n th√†nh ki·ªÉm tra icon k√™nh!");
}

/* 
============================================
X·ª≠ l√Ω request t·ª´ Telegram (Webhook) & Gemini Integration
============================================
*/

function doPost(e) {
    try {
        const update = JSON.parse(e.postData.contents);

        if (update.message) {
            const chatId = update.message.chat.id;
            const text = update.message.text;

            if (text) {
                // X·ª≠ l√Ω l·ªánh
                if (text.startsWith('/')) {
                    handleTelegramCommand(text, chatId);
                }
            }
        }

        return ContentService.createTextOutput(JSON.stringify({ method: "post" }));
    } catch (error) {
        Logger.log('L·ªói doPost: ' + error.toString());
        return ContentService.createTextOutput(JSON.stringify({ error: error.toString() }));
    }
}

// X·ª≠ l√Ω c√°c l·ªánh Telegram
function handleTelegramCommand(commandText, chatId) {
    // T√°ch l·ªánh v√† tham s·ªë
    const parts = commandText.split(' ');
    const command = parts[0];
    const args = parts.slice(1);

    if (command === '/tomtat') {
        const url = args[0];
        if (!url) {
            sendTelegramMessageToChat(chatId, "‚ö†Ô∏è Vui l√≤ng nh·∫≠p URL c·∫ßn t√≥m t·∫Øt.\nV√≠ d·ª•: /tomtat https://example.com");
            return;
        }

        sendTelegramMessageToChat(chatId, "‚è≥ ƒêang ƒë·ªçc v√† t√≥m t·∫Øt n·ªôi dung, vui l√≤ng ƒë·ª£i...");

        const summary = summarizeUrl(url);
        sendTelegramMessageToChat(chatId, summary);
    } else if (command === '/tomtatvideo') {
        const url = args[0];
        if (!url || !url.includes('youtube')) {
            sendTelegramMessageToChat(chatId, "‚ö†Ô∏è Vui l√≤ng nh·∫≠p URL YouTube c·∫ßn t√≥m t·∫Øt.\nV√≠ d·ª•: /tomtatvideo https://youtube.com/watch?v=...");
            return;
        }

        sendTelegramMessageToChat(chatId, "‚è≥ ƒêang t√≥m t·∫Øt video YouTube, vui l√≤ng ƒë·ª£i (c√≥ th·ªÉ m·∫•t 30-60 gi√¢y)...");

        const summary = summarizeYouTubeVideo(url);
        if (summary) {
            sendTelegramMessageToChat(chatId, `üìù *T√≥m t·∫Øt video:*\n\n${summary}`);
        } else {
            sendTelegramMessageToChat(chatId, "‚ùå Kh√¥ng th·ªÉ t√≥m t·∫Øt video n√†y. Vui l√≤ng th·ª≠ l·∫°i sau.");
        }
    } else if (command === '/start') {
        sendTelegramMessageToChat(chatId, "üëã Xin ch√†o! T√¥i l√† bot h·ªó tr·ª£ Marketing.\n\nC√°c l·ªánh hi·ªán c√≥:\n/tomtat <url> - T√≥m t·∫Øt n·ªôi dung b√†i vi·∫øt t·ª´ URL\n/tomtatvideo <youtube_url> - T√≥m t·∫Øt video YouTube");
    }
}

// H√†m t√≥m t·∫Øt URL s·ª≠ d·ª•ng Gemini
function summarizeUrl(url) {
    try {
        // 1. L·∫•y n·ªôi dung trang web
        // L∆∞u √Ω: Apps Script c√≥ gi·ªõi h·∫°n v·ªÅ vi·ªác fetch c√°c trang web ph·ª©c t·∫°p (SPA, render b·∫±ng JS).
        // ƒê√¢y l√† c√°ch l·∫•y n·ªôi dung HTML c∆° b·∫£n.
        const response = UrlFetchApp.fetch(url, { muteHttpExceptions: true });
        const html = response.getContentText();

        // L·ªçc b·ªõt HTML tags ƒë·ªÉ l·∫•y text (c∆° b·∫£n)
        // C√°ch ƒë∆°n gi·∫£n nh·∫•t l√† x√≥a h·∫øt tag, nh∆∞ng c√≥ th·ªÉ m·∫•t c·∫•u tr√∫c.
        // ƒê·ªÉ t·ªët h∆°n, ta ch·ªâ l·∫•y ph·∫ßn body v√† x√≥a script/style.
        let textContent = html.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi, "")
            .replace(/<style[^>]*>([\s\S]*?)<\/style>/gi, "")
            .replace(/<[^>]+>/g, "\n")
            .replace(/\n\s*\n/g, "\n"); // X√≥a d√≤ng tr·ªëng th·ª´a

        // Gi·ªõi h·∫°n ƒë·ªô d√†i text ƒë·ªÉ tr√°nh qu√° t·∫£i token Gemini (v√≠ d·ª• 10000 k√Ω t·ª±)
        if (textContent.length > 30000) {
            textContent = textContent.substring(0, 30000) + "...";
        }

        const prompt = `H√£y t√≥m t·∫Øt v√† ph√¢n t√≠ch n·ªôi dung ch√≠nh t·ª´ vƒÉn b·∫£n sau ƒë√¢y (ƒë∆∞·ª£c l·∫•y t·ª´ URL: ${url}). 
        
        Y√™u c·∫ßu:
        1. T√≥m t·∫Øt c√°c √Ω ch√≠nh quan tr·ªçng.
        2. Ph√¢n t√≠ch c√°c ƒëi·ªÉm n·ªïi b·∫≠t ho·∫∑c insight marketing n·∫øu c√≥.
        3. Tr√¨nh b√†y ng·∫Øn g·ªçn, d·ªÖ hi·ªÉu b·∫±ng ti·∫øng Vi·ªát use markdown format.
        
        N·ªôi dung:
        ${textContent}`;

        return callGeminiApi(prompt);

    } catch (error) {
        return "‚ùå Kh√¥ng th·ªÉ t√≥m t·∫Øt URL n√†y. C√≥ th·ªÉ do l·ªói m·∫°ng ho·∫∑c trang web ch·∫∑n bot.\nL·ªói: " + error.toString();
    }
}

// G·ªçi Gemini API
function callGeminiApi(prompt) {
    try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`;

        const payload = {
            contents: [{
                parts: [{
                    text: prompt
                }]
            }]
        };

        const options = {
            method: 'post',
            contentType: 'application/json',
            payload: JSON.stringify(payload),
            muteHttpExceptions: true
        };

        const response = UrlFetchApp.fetch(url, options);
        const data = JSON.parse(response.getContentText());

        if (data.candidates && data.candidates.length > 0) {
            return data.candidates[0].content.parts[0].text;
        } else {
            Logger.log("Gemini Error: " + JSON.stringify(data));
            return "‚ùå C√≥ l·ªói x·∫£y ra v·ªõi Gemini API. Vui l√≤ng th·ª≠ l·∫°i sau.";
        }
    } catch (error) {
        Logger.log("Call Gemini API Error: " + error.toString());
        return "‚ùå L·ªói k·∫øt n·ªëi ƒë·∫øn Gemini API.";
    }
}

// H√†m t√≥m t·∫Øt video YouTube s·ª≠ d·ª•ng Gemini API v·ªõi fileData
function summarizeYouTubeVideo(videoUrl) {
    try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`;
        
        const prompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω AI chuy√™n t√≥m t·∫Øt video YouTube. H√£y t√≥m t·∫Øt video n√†y m·ªôt c√°ch chi ti·∫øt v√† c√≥ c·∫•u tr√∫c.

ƒê·ªãnh d·∫°ng output:

## T·ªïng quan
[M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ ch·ªß ƒë·ªÅ video trong 2-3 c√¢u]

## C√°c ƒëi·ªÉm ch√≠nh
- [ƒêi·ªÉm 1]
- [ƒêi·ªÉm 2]
- [ƒêi·ªÉm 3]

## Chi ti·∫øt n·ªôi dung
[T√≥m t·∫Øt chi ti·∫øt t·ª´ng ph·∫ßn c·ªßa video v·ªõi bullet points]

## K·∫øt lu·∫≠n
[K·∫øt lu·∫≠n v√† takeaways quan tr·ªçng]

H√£y vi·∫øt b·∫±ng ti·∫øng Vi·ªát, r√µ r√†ng v√† d·ªÖ hi·ªÉu.`;

        const payload = {
            contents: [{
                parts: [
                    { text: prompt },
                    {
                        fileData: {
                            mimeType: "video/youtube",
                            fileUri: videoUrl
                        }
                    }
                ]
            }],
            generationConfig: {
                temperature: 0.7,
                maxOutputTokens: 2048
            }
        };

        const options = {
            method: 'post',
            contentType: 'application/json',
            payload: JSON.stringify(payload),
            muteHttpExceptions: true
        };

        const response = UrlFetchApp.fetch(url, options);
        const data = JSON.parse(response.getContentText());

        if (data.candidates && data.candidates.length > 0) {
            return data.candidates[0].content.parts[0].text;
        } else {
            Logger.log("Gemini Video Summarize Error: " + JSON.stringify(data));
            return null;
        }
    } catch (error) {
        Logger.log("Summarize Video Error: " + error.toString());
        return null;
    }
}

// H√†m g·ª≠i tin nh·∫Øn ƒë·∫øn Chat ID c·ª• th·ªÉ (kh√°c v·ªõi h√†m g·ª≠i m·∫∑c ƒë·ªãnh d√πng CONFIG.TELEGRAM_CHAT_ID)
function sendTelegramMessageToChat(chatId, message) {
    const url = `https://api.telegram.org/bot${CONFIG.TELEGRAM_BOT_TOKEN}/sendMessage`;
    const payload = {
        method: 'post',
        payload: {
            chat_id: chatId,
            text: message,
            parse_mode: 'Markdown', // Gemini tr·∫£ v·ªÅ Markdown t·ªët h∆°n
            disable_web_page_preview: true
        }
    };

    try {
        UrlFetchApp.fetch(url, payload);
    } catch (e) {
        // Fallback n·∫øu l·ªói Markdown
        const payloadPlain = {
            method: 'post',
            payload: {
                chat_id: chatId,
                text: message,
                parse_mode: '',
                disable_web_page_preview: true
            }
        };
        UrlFetchApp.fetch(url, payloadPlain);
    }

}

// H√†m thi·∫øt l·∫≠p Webhook (Ch·∫°y 1 l·∫ßn sau khi deploy)
function setWebhook() {
    if (!CONFIG.WEB_APP_URL || CONFIG.WEB_APP_URL === '') {
        Logger.log("‚ùå L·ªói: B·∫°n ch∆∞a ƒëi·ªÅn URL Web App v√†o bi·∫øn CONFIG.WEB_APP_URL");
        return;
    }

    const url = `https://api.telegram.org/bot${CONFIG.TELEGRAM_BOT_TOKEN}/setWebhook?url=${CONFIG.WEB_APP_URL}`;
    const response = UrlFetchApp.fetch(url);
    Logger.log(response.getContentText());
}

function deleteWebhook() {
    const url = `https://api.telegram.org/bot${CONFIG.TELEGRAM_BOT_TOKEN}/deleteWebhook`;
    const response = UrlFetchApp.fetch(url);
    Logger.log(response.getContentText());
}
